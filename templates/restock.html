<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Reposici√≥n - {{ config.machine.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .restock-mode-active {
            background-color: #d4edda;
            border: 2px solid #28a745;
        }
        
        .door-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
        }
        
        .door-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        
        .door-card.out-of-stock {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .door-card.low-stock {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .door-card.available {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .stock-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .stock-controls input {
            width: 60px;
        }
        
        .stock-controls .btn {
            font-size: 12px;
            padding: 4px 8px;
        }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header del Panel -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                    <h2>Panel de Reposici√≥n</h2>
                    <div class="d-flex align-items-center gap-3">
                        <div id="restock-status" class="badge fs-6">
                            Cargando...
                        </div>
                        <button id="toggle-restock" class="btn btn-primary">
                            Activar Modo Reposici√≥n
                        </button>
                        <a href="/" class="btn btn-secondary">Volver a la m√°quina</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Control -->
        <div class="row mt-3" id="restock-panel" style="display: none;">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5>üîß Modo Reposici√≥n Activo</h5>
                    <p>Puede editar productos y stock. Los cambios se aplicar√°n inmediatamente.</p>
                </div>
            </div>
        </div>

        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="row mt-3">
            <div class="col-12">
                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                            üè™ Inventario
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">
                            üìä Historial de Ventas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab">
                            üíæ Exportar Datos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware" type="button" role="tab">
                            üîß Control Hardware
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Contenido de las Pesta√±as -->
        <div class="tab-content" id="adminTabContent">
            <!-- Pesta√±a de Inventario -->
            <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <!-- Grid de Puertas -->
                <div class="door-grid" id="doors-grid">
                    <!-- Las puertas se cargar√°n din√°micamente -->
                </div>
            </div>

            <!-- Pesta√±a de Historial de Ventas -->
            <div class="tab-pane fade" id="sales" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-12">
                        <!-- Filtros de Fecha -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>üìÖ Filtros de Fecha</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="start-date" class="form-label">Fecha Inicio</label>
                                        <input type="date" class="form-control" id="start-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="end-date" class="form-label">Fecha Fin</label>
                                        <input type="date" class="form-control" id="end-date">
                                    </div>
                                    <div class="col-md-2">
                                        <label for="limit-sales" class="form-label">L√≠mite</label>
                                        <select class="form-control" id="limit-sales">
                                            <option value="50">50</option>
                                            <option value="100" selected>100</option>
                                            <option value="500">500</option>
                                            <option value="1000">1000</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button class="btn btn-primary me-2" onclick="loadSalesHistory()">
                                            üîç Buscar
                                        </button>
                                        <button class="btn btn-secondary" onclick="clearSalesFilters()">
                                            üîÑ Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de Ventas -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üí∞ Total Ventas</h5>
                                        <h3 class="text-success" id="total-revenue">‚Ç¨0.00</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üì¶ Productos Vendidos</h5>
                                        <h3 class="text-primary" id="total-sales-count">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üìä Venta Promedio</h5>
                                        <h3 class="text-info" id="average-sale">‚Ç¨0.00</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">üïí Per√≠odo</h5>
                                        <small class="text-muted" id="sales-period">Todos los datos</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Historial -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h5>üìã Historial de Ventas</h5>
                                <div id="sales-loading" class="spinner-border spinner-border-sm" style="display: none;"></div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="sales-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Fecha</th>
                                                <th>Hora</th>
                                                <th>Puerta</th>
                                                <th>Producto</th>
                                                <th>Precio</th>
                                                <th>M√©todo Pago</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sales-tbody">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">
                                                    Cargando historial de ventas...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pesta√±a de Exportaci√≥n -->
            <div class="tab-pane fade" id="export" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-12">
                        <!-- Detecci√≥n de USB -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>üîå Detecci√≥n de USB</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p id="usb-status" class="mb-0">Verificando unidades USB...</p>
                                        <small class="text-muted">Las unidades USB se detectan autom√°ticamente</small>
                                    </div>
                                    <button class="btn btn-outline-primary" onclick="detectUSB()">
                                        üîÑ Actualizar
                                    </button>
                                </div>
                                <div id="usb-drives" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Opciones de Exportaci√≥n -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>üìÑ Exportar CSV</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Exporta el historial completo de ventas en formato CSV (Excel)</p>
                                        <button class="btn btn-success me-2" onclick="exportCSV()">
                                            üìã Generar CSV
                                        </button>
                                        <button class="btn btn-primary" onclick="exportToUSB('csv')" id="export-csv-usb" disabled>
                                            üíæ Exportar a USB
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>üìä Exportar Resumen JSON</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Exporta estad√≠sticas y resumen de ventas en formato JSON</p>
                                        <button class="btn btn-info me-2" onclick="exportJSON()">
                                            üìà Generar JSON
                                        </button>
                                        <button class="btn btn-primary" onclick="exportToUSB('json')" id="export-json-usb" disabled>
                                            üíæ Exportar a USB
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exportaci√≥n Autom√°tica -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>‚ö° Exportaci√≥n Autom√°tica</h5>
                            </div>
                            <div class="card-body">
                                <p>Exporta autom√°ticamente tanto CSV como JSON con los filtros actuales</p>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="export-start-date" class="form-label">Desde</label>
                                        <input type="date" class="form-control" id="export-start-date">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="export-end-date" class="form-label">Hasta</label>
                                        <input type="date" class="form-control" id="export-end-date">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-warning me-2" onclick="exportToUSBAuto()">
                                            üöÄ Exportaci√≥n Completa a USB
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar producto -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="edit-door-id">
                        
                        <div class="mb-3">
                            <label for="edit-name" class="form-label">Nombre del Producto</label>
                            <input type="text" class="form-control" id="edit-name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-price" class="form-label">Precio (‚Ç¨)</label>
                            <input type="number" class="form-control" id="edit-price" step="0.01" min="0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-stock" class="form-label">Stock Actual</label>
                            <input type="number" class="form-control" id="edit-stock" min="0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="edit-description" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-image-url" class="form-label">URL de Imagen</label>
                            <input type="text" class="form-control" id="edit-image-url">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let restockMode = false;
        let doors = {};

        // Cargar estado inicial
        document.addEventListener('DOMContentLoaded', function() {
            loadRestockStatus();
            loadDoors();
            
            // Event listeners
            document.getElementById('toggle-restock').addEventListener('click', toggleRestockMode);
        });

        async function loadRestockStatus() {
            try {
                const response = await fetch('/api/restock/mode');
                const data = await response.json();
                
                if (data.success) {
                    updateRestockStatus(data.restock_mode);
                }
            } catch (error) {
                console.error('Error al cargar estado de reposici√≥n:', error);
            }
        }

        async function loadDoors() {
            try {
                console.log('Cargando datos de puertas...');
                const response = await fetch('/api/doors');
                const data = await response.json();
                
                console.log('Respuesta del servidor:', data);
                
                if (data.success) {
                    doors = data.doors;
                    console.log('Puertas cargadas:', Object.keys(doors).length);
                    renderDoors();
                } else {
                    console.error('Error en respuesta del servidor:', data.error);
                }
            } catch (error) {
                console.error('Error al cargar puertas:', error);
            }
        }

        function updateRestockStatus(status) {
            restockMode = status.active;
            
            const statusElement = document.getElementById('restock-status');
            const toggleButton = document.getElementById('toggle-restock');
            const panel = document.getElementById('restock-panel');
            
            if (restockMode) {
                statusElement.textContent = 'Modo Reposici√≥n ACTIVO';
                statusElement.className = 'badge bg-success fs-6';
                toggleButton.textContent = 'Desactivar Modo Reposici√≥n';
                toggleButton.className = 'btn btn-danger';
                panel.style.display = 'block';
            } else {
                statusElement.textContent = 'Modo Normal';
                statusElement.className = 'badge bg-secondary fs-6';
                toggleButton.textContent = 'Activar Modo Reposici√≥n';
                toggleButton.className = 'btn btn-primary';
                panel.style.display = 'none';
            }
        }

        async function toggleRestockMode() {
            try {
                const response = await fetch('/api/restock/toggle', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    updateRestockStatus({active: data.restock_mode});
                    renderDoors(); // Refrescar para mostrar/ocultar controles
                } else {
                    alert('Error al cambiar modo de reposici√≥n');
                }
            } catch (error) {
                console.error('Error al alternar modo reposici√≥n:', error);
            }
        }

        function renderDoors() {
            const grid = document.getElementById('doors-grid');
            console.log('Renderizando puertas. Grid encontrado:', !!grid);
            console.log('N√∫mero de puertas a renderizar:', Object.keys(doors).length);
            
            if (!grid) {
                console.error('No se encontr√≥ el elemento doors-grid');
                return;
            }
            
            grid.innerHTML = '';
            
            Object.entries(doors).forEach(([doorId, door]) => {
                console.log(`Procesando puerta ${doorId}:`, door);
                const product = door.product;
                const status = door.status || 'no_product';
                
                const doorCard = document.createElement('div');
                doorCard.className = `door-card ${status}`;
                
                doorCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">Puerta ${doorId}</h6>
                        <span class="badge bg-primary">GPIO ${door.gpio_pin}</span>
                    </div>
                    
                    ${product ? `
                        <div class="product-info">
                            <h6>${product.name}</h6>
                            <p class="mb-1">‚Ç¨${product.price.toFixed(2)}</p>
                            <p class="mb-1 text-muted">Stock: ${product.stock}</p>
                            ${product.description ? `<small class="text-muted">${product.description}</small>` : ''}
                        </div>
                        
                        ${restockMode ? `
                            <div class="stock-controls">
                                <button class="btn btn-sm btn-primary me-1" 
                                        onclick="editProduct('${doorId}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-sm btn-success" 
                                        onclick="openDoorFromInventory('${doorId}')" 
                                        title="Abrir puerta">üîì Abrir</button>
                            </div>
                        ` : ''}
                    ` : `
                        <div class="text-muted">
                            <p>Sin producto configurado</p>
                            ${restockMode ? `
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="editProduct('${doorId}')">Configurar Producto</button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="openDoorFromInventory('${doorId}')" 
                                            title="Abrir puerta">üîì Abrir</button>
                                </div>
                            ` : ''}
                        </div>
                    `}
                `;
                
                grid.appendChild(doorCard);
            });
        }

        async function restockDoor(doorId) {
            if (!restockMode) {
                alert('Modo reposici√≥n no activo');
                return;
            }
            
            const quantityInput = document.getElementById(`restock-${doorId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            try {
                const response = await fetch(`/api/restock/door/${doorId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        quantity: quantity,
                        operator: 'admin',
                        notes: `Reposici√≥n manual de ${quantity} unidades`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    loadDoors(); // Recargar para actualizar stock
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error al reabastecer:', error);
                alert('Error de conexi√≥n');
            }
        }

        function editProduct(doorId) {
            if (!restockMode) {
                alert('Modo reposici√≥n no activo');
                return;
            }
            
            const door = doors[doorId];
            const product = door.product;
            
            // Llenar formulario
            document.getElementById('edit-door-id').value = doorId;
            document.getElementById('edit-name').value = product?.name || '';
            document.getElementById('edit-price').value = product?.price || 0;
            document.getElementById('edit-stock').value = product?.stock || 0;
            document.getElementById('edit-description').value = product?.description || '';
            document.getElementById('edit-image-url').value = product?.image_url || '';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }

        async function saveProduct() {
            const doorId = document.getElementById('edit-door-id').value;
            
            const productData = {
                name: document.getElementById('edit-name').value,
                price: parseFloat(document.getElementById('edit-price').value),
                stock: parseInt(document.getElementById('edit-stock').value),
                description: document.getElementById('edit-description').value,
                image_url: document.getElementById('edit-image-url').value,
                active: true
            };
            
            try {
                const response = await fetch(`/api/restock/product/${doorId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    loadDoors(); // Recargar datos
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                    modal.hide();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error al guardar producto:', error);
                alert('Error de conexi√≥n');
            }
        }

        // ============ FUNCIONES DE HISTORIAL DE VENTAS ============

        // Cargar historial de ventas
        async function loadSalesHistory() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const limit = document.getElementById('limit-sales').value;
            
            const loadingElement = document.getElementById('sales-loading');
            const tbody = document.getElementById('sales-tbody');
            
            loadingElement.style.display = 'block';
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Cargando...</td></tr>';
            
            try {
                // Construir URL con par√°metros
                let url = '/api/sales/history?limit=' + limit;
                if (startDate) url += '&start_date=' + startDate;
                if (endDate) url += '&end_date=' + endDate;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displaySalesHistory(data.sales);
                    await loadSalesSummary(startDate, endDate);
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar datos</td></tr>';
                }
            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error de conexi√≥n</td></tr>';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Mostrar historial de ventas en la tabla
        function displaySalesHistory(sales) {
            const tbody = document.getElementById('sales-tbody');
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay ventas en el per√≠odo seleccionado</td></tr>';
                return;
            }
            
            tbody.innerHTML = sales.map(sale => {
                const date = new Date(sale.timestamp);
                const statusBadge = sale.status === 'completed' ? 
                    '<span class="badge bg-success">Completada</span>' : 
                    '<span class="badge bg-warning">Pendiente</span>';
                
                return `
                    <tr>
                        <td>${sale.id}</td>
                        <td>${date.toLocaleDateString()}</td>
                        <td>${date.toLocaleTimeString()}</td>
                        <td><strong>${sale.door_id}</strong></td>
                        <td>${sale.product_name}</td>
                        <td class="text-success">‚Ç¨${sale.amount.toFixed(2)}</td>
                        <td>${sale.payment_method}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // Cargar resumen de ventas
        async function loadSalesSummary(startDate, endDate) {
            try {
                let url = '/api/sales/summary';
                const params = [];
                if (startDate) params.push('start_date=' + startDate);
                if (endDate) params.push('end_date=' + endDate);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const summary = data.summary;
                    document.getElementById('total-revenue').textContent = `‚Ç¨${summary.total_revenue.toFixed(2)}`;
                    document.getElementById('total-sales-count').textContent = summary.total_sales;
                    document.getElementById('average-sale').textContent = `‚Ç¨${summary.average_sale.toFixed(2)}`;
                    
                    // Actualizar per√≠odo
                    const periodText = startDate && endDate ? 
                        `${startDate} a ${endDate}` : 
                        startDate ? `Desde ${startDate}` : 
                        endDate ? `Hasta ${endDate}` : 'Todos los datos';
                    document.getElementById('sales-period').textContent = periodText;
                }
            } catch (error) {
                console.error('Error al cargar resumen:', error);
            }
        }

        // Limpiar filtros de ventas
        function clearSalesFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('limit-sales').value = '100';
            loadSalesHistory();
        }

        // ============ FUNCIONES DE EXPORTACI√ìN ============

        // Detectar unidades USB
        async function detectUSB() {
            try {
                const response = await fetch('/api/usb/detect');
                const data = await response.json();
                
                const statusElement = document.getElementById('usb-status');
                const drivesElement = document.getElementById('usb-drives');
                const exportButtons = document.querySelectorAll('#export-csv-usb, #export-json-usb');
                
                if (data.success && data.usb_drives.length > 0) {
                    statusElement.innerHTML = `<span class="text-success">‚úÖ ${data.count} unidad(es) USB detectada(s)</span>`;
                    drivesElement.innerHTML = data.usb_drives.map(drive => 
                        `<div class="badge bg-success me-2">${drive}</div>`
                    ).join('');
                    
                    // Habilitar botones de exportaci√≥n
                    exportButtons.forEach(btn => btn.disabled = false);
                } else {
                    statusElement.innerHTML = '<span class="text-warning">‚ö†Ô∏è No se detectaron unidades USB</span>';
                    drivesElement.innerHTML = '<small class="text-muted">Conecta una unidad USB y presiona "Actualizar"</small>';
                    
                    // Deshabilitar botones de exportaci√≥n
                    exportButtons.forEach(btn => btn.disabled = true);
                }
            } catch (error) {
                console.error('Error al detectar USB:', error);
                document.getElementById('usb-status').innerHTML = '<span class="text-danger">‚ùå Error al detectar USB</span>';
            }
        }

        // Exportar a CSV
        async function exportCSV() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                let url = '/api/sales/export/csv';
                const params = [];
                if (startDate) params.push('start_date=' + startDate);
                if (endDate) params.push('end_date=' + endDate);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Archivo CSV generado exitosamente: ' + data.filepath);
                } else {
                    alert('‚ùå Error al generar CSV: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Exportar a JSON
        async function exportJSON() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                let url = '/api/sales/export/json';
                const params = [];
                if (startDate) params.push('start_date=' + startDate);
                if (endDate) params.push('end_date=' + endDate);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Archivo JSON generado exitosamente: ' + data.filepath);
                } else {
                    alert('‚ùå Error al generar JSON: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Exportar a USB autom√°ticamente
        async function exportToUSBAuto() {
            try {
                const startDate = document.getElementById('export-start-date').value;
                const endDate = document.getElementById('export-end-date').value;
                
                const response = await fetch('/api/sales/export/usb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nArchivos exportados:\n${data.files.join('\n')}`);
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // ============ FUNCIONES DE CONTROL DE HARDWARE ============

        // Actualizar estado del hardware
        async function refreshHardwareStatus() {
            try {
                const statusElement = document.getElementById('hardware-system-status');
                statusElement.innerHTML = `
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Actualizando...</span>
                    </div> Actualizando estado...
                `;
                
                const response = await fetch('/api/hardware/doors/state');
                const data = await response.json();
                
                if (data.success) {
                    displayHardwareStatus(data.doors_state);
                    renderHardwareDoors(data.doors_state);
                } else {
                    statusElement.innerHTML = '<div class="text-danger">‚ùå Error al obtener estado del hardware</div>';
                }
            } catch (error) {
                console.error('Error al actualizar hardware:', error);
                document.getElementById('hardware-system-status').innerHTML = 
                    '<div class="text-danger">‚ùå Error de conexi√≥n</div>';
            }
        }

        // Mostrar estado del sistema hardware
        function displayHardwareStatus(doorsState) {
            const statusElement = document.getElementById('hardware-system-status');
            const totalDoors = Object.keys(doorsState).length;
            const openDoors = Object.values(doorsState).filter(door => door.is_open).length;
            const activeDoors = Object.values(doorsState).filter(door => door.relay_active).length;
            
            statusElement.innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="badge bg-primary fs-6">${totalDoors}</div>
                        <div class="small">Puertas Total</div>
                    </div>
                    <div class="col-4">
                        <div class="badge bg-warning fs-6">${openDoors}</div>
                        <div class="small">Puertas Abiertas</div>
                    </div>
                    <div class="col-4">
                        <div class="badge bg-info fs-6">${activeDoors}</div>
                        <div class="small">Rel√©s Activos</div>
                    </div>
                </div>
            `;
        }

        // Renderizar controles de puertas hardware
        function renderHardwareDoors(doorsState) {
            const grid = document.getElementById('hardware-doors-grid');
            grid.innerHTML = '';
            
            Object.entries(doorsState).forEach(([doorId, doorState]) => {
                const doorDiv = document.createElement('div');
                doorDiv.className = 'col-md-4 col-lg-3 mb-3';
                
                const statusClass = doorState.is_open ? 'border-warning' : 'border-success';
                const statusIcon = doorState.is_open ? 'üîì' : 'üîí';
                const relayIcon = doorState.relay_active ? '‚ö°' : 'üí§';
                
                doorDiv.innerHTML = `
                    <div class="card ${statusClass}" style="border-width: 2px;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>Puerta ${doorId}</strong>
                            <div>
                                <span title="Estado puerta">${statusIcon}</span>
                                <span title="Estado rel√©">${relayIcon}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <small class="text-muted">GPIO Rel√©:</small> 
                                <span class="badge bg-secondary">${doorState.gpio_pin || 'N/A'}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">GPIO Sensor:</small> 
                                <span class="badge bg-secondary">${doorState.sensor_pin || 'N/A'}</span>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           ${doorState.is_open ? 'checked' : ''} disabled>
                                    <label class="form-check-label small">
                                        ${doorState.is_open ? 'Abierta' : 'Cerrada'}
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           ${doorState.relay_active ? 'checked' : ''} disabled>
                                    <label class="form-check-label small">
                                        Rel√© ${doorState.relay_active ? 'Activo' : 'Inactivo'}
                                    </label>
                                </div>
                            </div>
                            <div class="d-grid gap-1">
                                <button class="btn btn-sm btn-primary" 
                                        onclick="openDoorHardware('${doorId}')"
                                        ${doorState.relay_active ? 'disabled' : ''}>
                                    üîì Abrir Puerta
                                </button>
                                <button class="btn btn-sm btn-warning" 
                                        onclick="testDoorHardware('${doorId}')">
                                    üß™ Probar
                                </button>
                            </div>
                            ${doorState.last_opened ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        √öltima apertura: ${new Date(doorState.last_opened * 1000).toLocaleString()}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                grid.appendChild(doorDiv);
            });
        }

        // Abrir puerta espec√≠fica
        async function openDoorHardware(doorId) {
            if (!confirm(`¬øAbrir la puerta ${doorId}?`)) return;
            
            try {
                const response = await fetch(`/api/hardware/door/${doorId}/open`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    // Actualizar estado despu√©s de un momento
                    setTimeout(refreshHardwareStatus, 1000);
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Abrir puerta desde el inventario
        async function openDoorFromInventory(doorId) {
            try {
                // Mostrar indicador de carga en el bot√≥n
                const button = event.target;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '‚è≥ Abriendo...';
                
                const response = await fetch(`/api/hardware/door/${doorId}/open`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar confirmaci√≥n visual temporal
                    button.innerHTML = '‚úÖ Abierta';
                    button.className = 'btn btn-sm btn-success';
                    
                    // Restaurar bot√≥n despu√©s de 2 segundos
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                        button.className = 'btn btn-sm btn-success';
                    }, 2000);
                } else {
                    // Mostrar error
                    button.innerHTML = '‚ùå Error';
                    button.className = 'btn btn-sm btn-danger';
                    
                    // Restaurar bot√≥n despu√©s de 2 segundos
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                        button.className = 'btn btn-sm btn-success';
                    }, 2000);
                    
                    console.error('Error al abrir puerta:', data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                
                // Restaurar bot√≥n en caso de error
                const button = event.target;
                button.disabled = false;
                button.innerHTML = '‚ùå Error';
                button.className = 'btn btn-sm btn-danger';
                
                setTimeout(() => {
                    button.innerHTML = 'üîì Abrir';
                    button.className = 'btn btn-sm btn-success';
                }, 2000);
            }
        }

        // Probar puerta espec√≠fica
        async function testDoorHardware(doorId) {
            alert('‚ùå Error de conexi√≥n');
        }

        // Probar puerta espec√≠fica
        async function testDoorHardware(doorId) {
            if (!confirm(`¬øProbar funcionamiento de la puerta ${doorId}?`)) return;
            
            try {
                const response = await fetch(`/api/hardware/door/${doorId}/test`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Prueba de puerta ${doorId} exitosa`);
                } else {
                    alert(`‚ùå Prueba fallida: ${data.error}`);
                }
                
                // Actualizar estado
                setTimeout(refreshHardwareStatus, 2000);
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Probar todas las puertas
        async function testAllDoors() {
            if (!confirm('¬øProbar todas las puertas? Esto puede tomar varios minutos.')) return;
            
            try {
                // Mostrar progreso
                const statusElement = document.getElementById('hardware-system-status');
                statusElement.innerHTML = `
                    <div class="text-info">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Probando todas las puertas...
                    </div>
                `;
                
                const response = await fetch('/api/hardware/doors/test', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    const results = data.test_results;
                    const successful = data.successful_tests;
                    const total = data.total_doors;
                    
                    let message = `Prueba completada:\n‚úÖ ${successful}/${total} puertas funcionando correctamente\n\n`;
                    
                    Object.entries(results).forEach(([doorId, success]) => {
                        message += `Puerta ${doorId}: ${success ? '‚úÖ OK' : '‚ùå Error'}\n`;
                    });
                    
                    alert(message);
                } else {
                    alert(`‚ùå Error en las pruebas: ${data.error}`);
                }
                
                // Actualizar estado
                refreshHardwareStatus();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Parada de emergencia
        async function emergencyStop() {
            if (!confirm('‚ö†Ô∏è ¬øPARADA DE EMERGENCIA?\n\nEsto detendr√° inmediatamente todos los rel√©s activos.')) return;
            
            try {
                const response = await fetch('/api/hardware/emergency-stop', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('üõë Parada de emergencia ejecutada');
                    refreshHardwareStatus();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // ============ INICIALIZACI√ìN ============

        // Inicializar pesta√±as
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar historial inicial cuando se abre la pesta√±a
            document.getElementById('sales-tab').addEventListener('shown.bs.tab', function() {
                loadSalesHistory();
            });
            
            // Cargar detecci√≥n USB cuando se abre la pesta√±a
            document.getElementById('export-tab').addEventListener('shown.bs.tab', function() {
                detectUSB();
            });
            
            // Cargar hardware cuando se abre la pesta√±a
            document.getElementById('hardware-tab').addEventListener('shown.bs.tab', function() {
                refreshHardwareStatus();
            });
            
            // Auto-detectar USB cada 5 segundos en la pesta√±a de exportaci√≥n
            setInterval(() => {
                if (document.getElementById('export').classList.contains('show')) {
                    detectUSB();
                }
            }, 5000);
            
            // Auto-actualizar hardware cada 10 segundos en la pesta√±a de hardware
            setInterval(() => {
                if (document.getElementById('hardware').classList.contains('show')) {
                    refreshHardwareStatus();
                }
            }, 10000);
        });
    </script>
</body>
</html>
